name: Check Pull Request

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review

jobs:
  pr-validator:
    name: Run Pull Request Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install uv
        run: pipx install uv

      - name: Install dependencies
        run: uv sync --frozen

      - name: Lint with ruff
        run: uv run ruff check

      - name: Run tests
        run: uv run pytest

      - name: Test Docker Image Build
        run: |
          set +e
          docker build --no-cache --tag nrf-impact-assess-worker .
          exit $?

      - name: Start compose stack
        run: |
          mkdir -p iat_input  # Create empty data dir for volume mount
          docker compose up --build --wait --wait-timeout 120

      - name: Verify worker health
        run: curl -sf http://localhost:8085/health | grep -q '"status":"ok"'

      - name: Teardown compose stack
        if: always()
        run: docker compose down --volumes

#      - name: SonarCloud Scan
#        if: github.actor != 'dependabot[bot]'
#        uses: SonarSource/sonarcloud-github-action@master
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
